section .data
    fib_int.call_count dd 0
    str_1 db `fib called %d times\n`, 0
    str_2 db `Fibonacci of %d is %d\n`, 0
    str_3 db `Product of array elements is %d\n`, 0

section .text
    global main
    extern printf
    extern scanf
    extern malloc
    extern free
    extern nullptr

fib_int:
    push ebp
    mov ebp, esp
    sub esp, 36
    mov eax, [fib_int.call_count]
    mov [ebp-8], eax
    mov eax, [ebp-8]
    add eax, 1
    mov [fib_int.call_count], eax
    mov eax, [fib_int.call_count]
    push eax
    mov eax, str_1
    push eax
    call printf
    mov [ebp-12], eax
    add esp, 8
    mov eax, [ebp+8]
    cmp eax, 1
    setle al
    movzx eax, al
    mov [ebp-16], eax
    mov eax, [ebp-16]
    test eax, eax
    jz fib_int.L1
    mov eax, 1
    mov esp, ebp
    pop ebp
    ret
fib_int.L1:
    mov eax, [ebp+8]
    sub eax, 1
    mov [ebp-20], eax
    mov eax, [ebp-20]
    push eax
    call fib_int
    mov [ebp-24], eax
    add esp, 4
    mov eax, [ebp+8]
    sub eax, 2
    mov [ebp-28], eax
    mov eax, [ebp-28]
    push eax
    call fib_int
    mov [ebp-32], eax
    add esp, 4
    mov eax, [ebp-24]
    mov ebx, [ebp-32]
    add eax, ebx
    mov [ebp-36], eax
    mov eax, [ebp-36]
    mov esp, ebp
    pop ebp
    ret
arr_prod_intptr_int:
    push ebp
    mov ebp, esp
    sub esp, 16
arr_prod_intptr_int.L1:
    mov eax, [ebp-8]
    mov ebx, [ebp+12]
    cmp eax, ebx
    setl al
    movzx eax, al
    mov [ebp-12], eax
    mov eax, [ebp-12]
    test eax, eax
    jz arr_prod_intptr_int.L3
    sub esp, 8
    mov eax, [ebp-4]
    imul eax, [ebp-24]
    mov [ebp-4], eax
arr_prod_intptr_int.L2:
    mov eax, [ebp-8]
    mov [ebp-16], eax
    jmp arr_prod_intptr_int.L1
arr_prod_intptr_int.L3:
    mov eax, [ebp-4]
    mov esp, ebp
    pop ebp
    ret
main:
    push ebp
    mov ebp, esp
    sub esp, 60
    mov dword [ebp-4], 5
    mov eax, [ebp-4]
    push eax
    call fib_int
    mov [ebp-8], eax
    add esp, 4
    mov eax, [ebp-8]
    mov [ebp-12], eax
    push 1
    call fib_int
    mov [ebp-16], eax
    add esp, 4
    push 0
    call fib_int
    mov [ebp-20], eax
    add esp, 4
    mov eax, [ebp-12]
    push eax
    mov eax, [ebp-4]
    push eax
    mov eax, str_2
    push eax
    call printf
    mov [ebp-24], eax
    add esp, 12
    lea eax, [ebp-40]
    mov [ebp-44], eax
    add dword [ebp-44], 4
    add dword [ebp-44], 4
    add dword [ebp-44], 4
    mov dword [ebp-48], 4
    mov eax, [ebp-48]
    push eax
    mov eax, [ebp-40]
    push eax
    call arr_prod_intptr_int
    mov [ebp-52], eax
    add esp, 8
    mov eax, [ebp-52]
    mov [ebp-56], eax
    mov eax, [ebp-56]
    push eax
    mov eax, str_3
    push eax
    call printf
    mov [ebp-60], eax
    add esp, 8
    xor eax, eax
    mov esp, ebp
    pop ebp
    ret
